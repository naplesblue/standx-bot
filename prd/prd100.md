# StandX Maker Bot 开发文档

## 概述

在 StandX 永续合约平台双边挂单做市，通过价格监控和自动撤单避免成交。

## 配置项

```yaml
# 挂单参数
order_distance_bps: 10 # 挂单距离 last_price 的 bps
cancel_distance_bps: 5 # 价格靠近到这个距离时撤单
order_size_btc: 0.01 # 单笔挂单大小

# 仓位控制
max_position_btc: 0.1 # 最大持仓（绝对值），超过停止做市

# 波动率控制（重挂条件）
volatility_window_sec: 5 # 观察窗口秒数
volatility_threshold_bps: 5 # 窗口内波动小于此值才允许挂单
```

## 核心逻辑

### 主循环

```
初始化:
  连接 WebSocket 订阅价格
  维护价格滑动窗口

主循环:
  1. 检查当前持仓
     if abs(position) >= max_position_btc:
       停止挂单，等待仓位减少
       continue

  2. 检查现有挂单
     for each 挂单:
       if 距离 last_price < cancel_distance_bps:
         加入撤单列表

     if 撤单列表非空:
       批量撤单（使用 cl_ord_id）
       continue  # 撤单后本轮不挂新单

  3. 检查是否可以挂单
     if 波动率 > volatility_threshold_bps:
       continue  # 等待价格稳定

     if 缺少 buy 单:
       生成 cl_ord_id，挂 buy 单 @ last_price * (1 - order_distance_bps/10000)
     if 缺少 sell 单:
       生成 cl_ord_id，挂 sell 单 @ last_price * (1 + order_distance_bps/10000)
```

### 波动率计算

```python
# 维护滑动窗口
price_window = []  # [(timestamp, price), ...]

def on_price_update(price):
    now = time.time()
    price_window.append((now, price))
    # 清理过期数据
    cutoff = now - volatility_window_sec
    price_window = [(t, p) for t, p in price_window if t > cutoff]

def get_volatility_bps():
    if len(price_window) < 2:
        return float('inf')  # 数据不足，不挂单
    prices = [p for _, p in price_window]
    return (max(prices) - min(prices)) / prices[-1] * 10000
```

### 成交处理

```
on_order_filled(order, filled_qty):
  更新本地仓位记录

  if abs(position) >= max_position_btc:
    # 仓位过大，停止做市
    撤销所有挂单
    # 可选：市价平仓
```

## API 参考

### Base URL

```
HTTP:      https://perps.standx.com
WebSocket: wss://perps.standx.com/ws-stream/v1
```

### 认证

所有交易接口需要 JWT + 签名：

```
Headers:
  Authorization: Bearer <jwt_token>
  x-request-sign-version: v1
  x-request-id: <uuid>
  x-request-timestamp: <timestamp_ms>
  x-request-signature: <ed25519_signature>
```

JWT 获取流程见：https://docs.standx.com/standx-api/perps-auth

### 获取价格

```
GET /api/query_symbol_price?symbol=BTC-USD

Response:
{
  "last_price": "98500.43",
  "index_price": "98501.15",
  "last_price": "98499.94"
}
```

### 下单

```
POST /api/new_order

Body:
{
  "symbol": "BTC-USD",
  "side": "buy",              // buy | sell
  "order_type": "limit",
  "qty": "0.01",
  "price": "98300.00",
  "time_in_force": "gtc",
  "reduce_only": false,
  "cl_ord_id": "my-order-001"  // 客户端订单ID，用于跟踪
}

Response:
{
  "code": 0,
  "message": "success",
  "request_id": "xxx"
}

注意：响应不返回 order_id，需要通过 cl_ord_id 跟踪订单状态
```

### 撤单（单个）

```
POST /api/cancel_order

Body:
{
  "cl_ord_id": "my-order-001"  // 或使用 order_id
}
```

### 撤单（批量）

```
POST /api/cancel_orders

Body:
{
  "cl_ord_id_list": ["order-001", "order-002"]  // 或使用 order_id_list
}
```

### 查询挂单

```
GET /api/query_open_orders?symbol=BTC-USD

Response:
{
  "result": [
    {
      "id": 12345,
      "side": "buy",
      "price": "98300.00",
      "qty": "0.01",
      "status": "open"
    }
  ]
}
```

### 查询持仓

```
GET /api/query_positions?symbol=BTC-USD

Response:
[
  {
    "qty": "0.05",
    "entry_price": "98400.00",
    "upnl": "-10.5"
  }
]
```

### 查询余额

```
GET /api/query_balance

Response:
{
  "cross_available": "10000.00",
  "equity": "10500.00"
}
```

### WebSocket 订阅

需要两个 WebSocket 连接：

**1. 市场数据流** `wss://perps.standx.com/ws-stream/v1`

```json
// 订阅价格
{ "subscribe": { "channel": "price", "symbol": "BTC-USD" } }

// 推送数据包含 last_price, last_price, index_price
```

**2. 用户数据流** `wss://perps.standx.com/ws-api/v1`

```json
// 先认证
{
  "session_id": "<uuid>",
  "method": "auth:login",
  "params": "{\"token\":\"<jwt>\"}"
}

// 订阅用户级 channel（认证后自动推送）
// - order: 订单状态变化（成交、撤销等）
// - position: 仓位变化
// - trade: 成交记录
```

文档：https://docs.standx.com/standx-api/perps-ws

## 状态管理

本地维护：

```python
state = {
    "last_price": None,          # 最新成交价（用于挂单计算）
    "price_window": [],          # 波动率计算用
    "position": 0.0,             # 当前净持仓
    "open_orders": {
        "buy": None,             # {"cl_ord_id": "xxx", "price": "98300"}
        "sell": None
    }
}
```

- 价格通过 `ws-stream` 的 `price` channel 实时更新
- 订单/仓位通过 `ws-api` 的用户 channel 实时更新
- 启动时通过 HTTP API 初始化状态

## 参考链接

- API 总览：https://docs.standx.com/standx-api/standx-api
- HTTP API：https://docs.standx.com/standx-api/perps-http
- WebSocket：https://docs.standx.com/standx-api/perps-ws
- 认证：https://docs.standx.com/standx-api/perps-auth
